# μΉ΄ν”„μΉ΄ μ¤νΈλ¦Όμ¦ μλ„μ° νƒ€μ΄λ° & DB μ μ¬ μ‹μ 

## π• ν•µμ‹¬ μ§λ¬Έ

### Q1: DBμ— μ μ¬λλ” νƒ€μ΄λ°μ΄ μ–Έμ μ•Ό?
### Q2: μ§‘κ³„κ°€ λ‹¤ λ κ²ƒμ„ μ»¨μλ¨Έλ” μ–΄λ–»κ² μ•μ•„?

## π“… νƒ€μ„λΌμΈμΌλ΅ μ΄ν•΄ν•κΈ°

### 1μ‹κ°„ μλ„μ° μμ‹ (14:00 ~ 15:00)

```
14:00:00 β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ 15:00:00 β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ 15:00:01
   β”‚                                 β”‚              β”‚
   β”‚β† β”€β”€β”€β”€β”€β”€β”€β”€ μλ„μ° κΈ°κ°„ β”€β”€β”€β”€β”€β”€β”€β”€β†’β”‚              β”‚
   β”‚                                 β”‚              β”‚
   β”‚                                 β”‚              β”‚
14:05 λ°μ΄ν„° μ…λ ¥ (λ…ΈνΈλ¶ 150λ§μ›)   β”‚              β”‚
   β”‚  β†’ μ¤νΈλ¦Όμ¦ λ‚΄λ¶€ μƒνƒ: 150λ§μ›  β”‚              β”‚
   β”‚  β†’ Output ν† ν”½: μ „μ†΅ μ• ν•¨ β   β”‚              β”‚
   β”‚  β†’ DB μ €μ¥: μ• λ¨ β           β”‚              β”‚
   β”‚                                 β”‚              β”‚
14:30 λ°μ΄ν„° μ…λ ¥ (λ…ΈνΈλ¶ 180λ§μ›)   β”‚              β”‚
   β”‚  β†’ μ¤νΈλ¦Όμ¦ λ‚΄λ¶€ μƒνƒ: 330λ§μ›  β”‚              β”‚
   β”‚  β†’ Output ν† ν”½: μ „μ†΅ μ• ν•¨ β   β”‚              β”‚
   β”‚  β†’ DB μ €μ¥: μ• λ¨ β           β”‚              β”‚
   β”‚                                 β”‚              β”‚
14:50 λ°μ΄ν„° μ…λ ¥ (λ…ΈνΈλ¶ 200λ§μ›)   β”‚              β”‚
   β”‚  β†’ μ¤νΈλ¦Όμ¦ λ‚΄λ¶€ μƒνƒ: 530λ§μ›  β”‚              β”‚
   β”‚  β†’ Output ν† ν”½: μ „μ†΅ μ• ν•¨ β   β”‚              β”‚
   β”‚  β†’ DB μ €μ¥: μ• λ¨ β           β”‚              β”‚
   β”‚                                 β”‚              β”‚
   β”‚                            [μλ„μ° μΆ…λ£]        β”‚
   β”‚                                 β”‚              β”‚
   β”‚                                 β”‚         [μ΄λ²¤νΈ μ‹κ°„]
   β”‚                                 β”‚         15:00 μ΄ν›„ λ°μ΄ν„° λ„μ°©
   β”‚                                 β”‚              β”‚
   β”‚                                 β”‚              β–Ό
   β”‚                                 β”‚         β… μλ„μ° λ‹«ν!
   β”‚                                 β”‚         β… Output ν† ν”½μ— μ „μ†΅
   β”‚                                 β”‚            "λ…ΈνΈλ¶ 530λ§μ›"
   β”‚                                 β”‚              β”‚
   β”‚                                 β”‚              β–Ό
   β”‚                                 β”‚         β… μ»¨μλ¨Έ μμ‹ 
   β”‚                                 β”‚              β”‚
   β”‚                                 β”‚              β–Ό
   β”‚                                 β”‚         β… DBμ— μ €μ¥!
```

## π” μƒμ„Έ μ„¤λ…

### 1. μλ„μ°κ°€ μ—΄λ¦¬λ” μ‹μ 
```java
TimeWindows.ofSizeWithNoGrace(Duration.ofHours(1))
```

- **14:00:00μ— λ°μ΄ν„°κ°€ μ²μ λ“¤μ–΄μ¤λ©΄** β†’ 14:00~15:00 μλ„μ° μƒμ„±
- μλ„μ°λ” **μ΄λ²¤νΈ μ‹κ°„ κΈ°μ¤€**μΌλ΅ μƒμ„±λ¨

### 2. μ§‘κ³„ μ¤‘ (μλ„μ°κ°€ μ—΄λ ¤μλ” λ™μ•)

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚         μΉ΄ν”„μΉ΄ μ¤νΈλ¦Όμ¦ λ‚΄λ¶€ μƒνƒ μ €μ¥μ†        β”‚
β”‚                (RocksDB)                       β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”¤
β”‚ μλ„μ°: 14:00~15:00                            β”‚
β”‚ μƒν’: λ…ΈνΈλ¶                                   β”‚
β”‚ ν„μ¬ λ„μ  κΈμ•΅: 530λ§μ›  β† μ‹¤μ‹κ°„ μ—…λ°μ΄νΈ    β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
         β”‚
         β”‚ μ•„μ§ Output ν† ν”½μ— μ „μ†΅ μ• ν•¨! β
         β–Ό
    (Output ν† ν”½: λΉ„μ–΄μμ)
         β”‚
         β–Ό
    (μ»¨μλ¨Έ: λ°›μ„ λ©”μ‹μ§€ μ—†μ)
         β”‚
         β–Ό
    (DB: μ €μ¥ μ• λ¨)
```

**μ¤‘μ”:** μ΄ μ‹μ μ—λ” DBμ— μ €μ¥λμ§€ μ•μµλ‹λ‹¤!

### 3. μλ„μ°κ°€ λ‹«νλ” μ‹μ  π―

**μ–Έμ  λ‹«νλ‚?**

```java
// ν„μ¬ μ½”λ“
TimeWindows.ofSizeWithNoGrace(Duration.ofHours(1))
```

#### μ΅°κ±΄: μλ„μ° μΆ…λ£ μ‹κ°„(15:00) μ΄ν›„μ λ°μ΄ν„°κ°€ λ„μ°©ν•  λ•

```
15:00:01 μ‹μ μ— μƒλ΅μ΄ λ°μ΄ν„°κ°€ μΉ΄ν”„μΉ΄μ— λ„μ°©
  β”‚
  β”β”€β†’ μ¤νΈλ¦Όμ¦κ°€ κ°μ§€: "μ•„, 15:00μ΄ μ§€λ‚¬λ„¤?"
  β”‚
  β”β”€β†’ 14:00~15:00 μλ„μ°λ¥Ό λ‹«μ
  β”‚
  β”β”€β†’ μµμΆ… μ§‘κ³„ κ²°κ³Όλ¥Ό Output ν† ν”½μΌλ΅ μ „μ†΅ β…
  β”‚    "μƒν’:λ…ΈνΈλ¶, μ‹κ°„λ€:14:00~15:00, μ΄λ§¤μ¶:5300000"
  β”‚
  β””β”€β†’ μλ„μ° μ‚­μ  (λ©”λ¨λ¦¬ μ •λ¦¬)
```

### 4. μ»¨μλ¨Έκ°€ λ°›λ” μ‹μ 

```
Output ν† ν”½μ— λ©”μ‹μ§€κ°€ λ„μ°©
  β”‚
  β–Ό
@KafkaListenerκ°€ μ¦‰μ‹ κ°μ§€ β…
  β”‚
  β–Ό
TimeWindowConsumer.listenHourlySalesResult() μ‹¤ν–‰
  β”‚
  β–Ό
AggregationStorageService.saveHourlySalesResult() νΈμ¶
  β”‚
  β–Ό
DBμ— INSERT β…
  β”‚
  β–Ό
μ½μ†” λ΅κ·Έ μ¶λ ¥: "π’Ύ [DB μ €μ¥ μ™„λ£]"
```

## β΅ μ‹¤μ‹κ°„ νλ¦„ μμ‹

### μ‹λ‚λ¦¬μ¤: 14:00~15:00 μ‹κ°„λ³„ λ§¤μ¶ μ§‘κ³„

```bash
# ν„°λ―Έλ„μ—μ„ μ‹¤ν–‰
curl -X POST "http://localhost:8080/api/time-window/hourly-sales?product=λ…ΈνΈλ¶&amount=1500000"
```

**14:05 - μ²« λ²μ§Έ λ°μ΄ν„° μ…λ ¥**
```
[μ¤νΈλ¦Ό-μ‹κ°„λ³„μ§‘κ³„] μ…λ ¥ - μƒν’: λ…ΈνΈλ¶, κΈμ•΅: 1500000
[μ¤νΈλ¦Ό-μ‹κ°„λ³„μ§‘κ³„] μƒν’: λ…ΈνΈλ¶, κΈμ•΅: 1500000, λ„μ : 0 -> 1500000

β† Output ν† ν”½: μ „μ†΅ μ• ν•¨
β† DB: μ €μ¥ μ• λ¨
```

**14:30 - λ‘ λ²μ§Έ λ°μ΄ν„° μ…λ ¥**
```
[μ¤νΈλ¦Ό-μ‹κ°„λ³„μ§‘κ³„] μ…λ ¥ - μƒν’: λ…ΈνΈλ¶, κΈμ•΅: 1800000
[μ¤νΈλ¦Ό-μ‹κ°„λ³„μ§‘κ³„] μƒν’: λ…ΈνΈλ¶, κΈμ•΅: 1800000, λ„μ : 1500000 -> 3300000

β† Output ν† ν”½: μ „μ†΅ μ• ν•¨
β† DB: μ €μ¥ μ• λ¨
```

**14:50 - μ„Έ λ²μ§Έ λ°μ΄ν„° μ…λ ¥**
```
[μ¤νΈλ¦Ό-μ‹κ°„λ³„μ§‘κ³„] μ…λ ¥ - μƒν’: λ…ΈνΈλ¶, κΈμ•΅: 2000000
[μ¤νΈλ¦Ό-μ‹κ°„λ³„μ§‘κ³„] μƒν’: λ…ΈνΈλ¶, κΈμ•΅: 2000000, λ„μ : 3300000 -> 5300000

β† Output ν† ν”½: μ „μ†΅ μ• ν•¨
β† DB: μ €μ¥ μ• λ¨
```

**15:05 - μƒλ΅μ΄ μλ„μ°μ λ°μ΄ν„° μ…λ ¥ (15:00~16:00 μλ„μ°)**
```
[μ¤νΈλ¦Ό-μ‹κ°„λ³„μ§‘κ³„] μ…λ ¥ - μƒν’: λ…ΈνΈλ¶, κΈμ•΅: 1000000

β† μ΄ μ‹μ μ— μ¤νΈλ¦Όμ¦κ°€ κ°μ§€: "15:00μ΄ μ§€λ‚¬λ„¤!"

β… [μ‹κ°„λ³„μ§‘κ³„ κ²°κ³Ό] μƒν’:λ…ΈνΈλ¶, μ‹κ°„λ€:14:00~15:00, μ΄λ§¤μ¶:5300000
   β†“
π• [μ‹κ°„λ³„ μ§‘κ³„ μµμΆ…κ²°κ³Ό] Topic: hourly-sales-output-topic, Offset: 0, κ²°κ³Ό: μƒν’:λ…ΈνΈλ¶...
   β†“
π’Ύ [DB μ €μ¥ μ™„λ£] μ‹κ°„λ³„ λ§¤μ¶ - μƒν’: λ…ΈνΈλ¶, λ§¤μ¶: 5300000μ› β…β…β…
```

## π“ Grace Periodλ€?

### ofSizeWithNoGrace (ν„μ¬ μ‚¬μ©)

```java
TimeWindows.ofSizeWithNoGrace(Duration.ofHours(1))
```

```
14:00 β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ 15:00
  β”‚                  β”‚
  β”‚                  β”β”€β†’ 15:00 μ΄ν›„ μ²« λ°μ΄ν„° λ„μ°© μ‹ μ¦‰μ‹ μλ„μ° λ‹«ν
  β”‚                  β”‚
  β”‚                  β””β”€β†’ 15:05μ— 14:50 λ°μ΄ν„°κ°€ λ¦κ² λ„μ°©? λ¬΄μ‹λ¨! β
```

### ofSizeAndGrace (Grace Period μμ)

```java
TimeWindows.ofSizeAndGrace(Duration.ofHours(1), Duration.ofMinutes(10))
```

```
14:00 β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€ 15:00 β”€β”€β”€β”€ 15:10
  β”‚                  β”‚          β”‚
  β”‚                  β”‚          β”β”€β†’ 15:10κΉμ§€λ” λ¦κ² λ„μ°©ν• λ°μ΄ν„°λ„ μ§‘κ³„ β…
  β”‚                  β”‚          β”‚
  β”‚                  β””β”€β†’ Grace Period (μ μ κΈ°κ°„)
```

**Grace Period μ‚¬μ© μμ‹:**
```java
@Bean
public KStream<String, String> kStreamWithGrace(StreamsBuilder streamsBuilder) {
    KStream<String, String> stream = streamsBuilder.stream("hourly-sales-topic");
    
    stream
        .groupByKey()
        .windowedBy(
            TimeWindows.ofSizeAndGrace(
                Duration.ofHours(1),      // μλ„μ° ν¬κΈ°
                Duration.ofMinutes(10)    // Grace Period: 10λ¶„
            )
        )
        .aggregate(...)
        .toStream()
        .to("output-topic");
    
    return stream;
}
```

**μ¥μ :** λ„¤νΈμ›ν¬ μ§€μ—°μ΄λ‚ μ‹κ³„ λ¶μΌμΉλ΅ λ¦κ² λ„μ°©ν• λ°μ΄ν„°λ„ μ²λ¦¬
**λ‹¨μ :** μλ„μ°κ°€ λ¦κ² λ‹«ν€μ„ κ²°κ³Ό μ „μ†΅μ΄ μ§€μ—°λ¨

## π― μ»¨μλ¨Έλ” μ–΄λ–»κ² μ•μ•„?

### λ‹µλ³€: μ»¨μλ¨Έλ” "μ• ν•„μ”κ°€ μ—†μ–΄μ”!"

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Kafka Streams   β”‚ β† μλ„μ° κ΄€λ¦¬, λ‹«ν μ‹μ  νλ‹¨
β”‚    (μƒμ‚°μ)       β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
         β”‚
         β”‚ μλ„μ° λ‹«νλ©΄
         β”‚ μλ™μΌλ΅ μ „μ†΅
         β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚   Output Topic   β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
         β”‚
         β”‚ λ©”μ‹μ§€κ°€ μμΌλ©΄
         β”‚ μλ™μΌλ΅ μ „λ‹¬
         β–Ό
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚   @KafkaListener β”‚ β† κ·Έλƒ¥ λ°›κΈ°λ§ ν•λ©΄ λ¨!
β”‚    (μ»¨μλ¨Έ)       β”‚    "λ©”μ‹μ§€ μ™”λ„¤? DBμ— μ €μ¥!"
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

**μ»¨μλ¨Έ μ…μ¥:**
```java
@KafkaListener(topics = "hourly-sales-output-topic")
public void listen(String message) {
    // λ©”μ‹μ§€κ°€ μ¤λ©΄ = μλ„μ°κ°€ μ΄λ―Έ λ‹«ν”λ‹¤λ” λ»
    // κ·Έλƒ¥ μ €μ¥ν•λ©΄ λ!
    storageService.save(message);
}
```

## π”„ μ—¬λ¬ μλ„μ° λ™μ‹ μ‹¤ν–‰

```
μ‹κ°„λ€    μλ„μ°1       μλ„μ°2       μλ„μ°3
14:00   [14:00-15:00]
           μ§‘κ³„ μ¤‘...
15:00      β”‚        [15:00-16:00]
           λ‹«ν β†’      μ§‘κ³„ μ¤‘...
16:00      DBμ €μ¥ β…      β”‚        [16:00-17:00]
                        λ‹«ν β†’      μ§‘κ³„ μ¤‘...
17:00                   DBμ €μ¥ β…      β”‚
                                    λ‹«ν β†’
18:00                                DBμ €μ¥ β…
```

**κ° μλ„μ°λ” λ…λ¦½μ μΌλ΅ λ™μ‘!**

## π’΅ μ‹¤λ¬΄ μ‹λ‚λ¦¬μ¤

### μ‹λ‚λ¦¬μ¤ 1: μ‹¤μ‹κ°„ λ€μ‹λ³΄λ“

**μ”κµ¬μ‚¬ν•­:** λ§¤ μ‹κ°„ μ •κ°μ— μ΄μ „ μ‹κ°„ λ§¤μ¶μ„ λ€μ‹λ³΄λ“μ— ν‘μ‹

```
15:00:00 - 14μ‹ λ§¤μ¶ ν™•μ • ν•„μ”
15:00:30 - 15μ‹λ€ μ²« λ°μ΄ν„° λ„μ°©
         β†’ 14μ‹ μλ„μ° λ‹«ν
         β†’ DB μ €μ¥ β…
         β†’ λ€μ‹λ³΄λ“ κ°±μ‹  β…
```

### μ‹λ‚λ¦¬μ¤ 2: λ¦μ€ λ°μ΄ν„° μ²λ¦¬

**λ¬Έμ :** 14:55μ— λ°μƒν• λ°μ΄ν„°κ°€ 15:15μ— λ„μ°©

**ν•΄κ²°μ±… 1: Grace Period μ‚¬μ©**
```java
TimeWindows.ofSizeAndGrace(Duration.ofHours(1), Duration.ofMinutes(20))
// 15:20κΉμ§€λ” 14μ‹ λ°μ΄ν„° λ°›μ•„μ¤
```

**ν•΄κ²°μ±… 2: μ¬μ§‘κ³„**
```java
// λ¦κ² μ¨ λ°μ΄ν„°λ” λ³„λ„ ν† ν”½μΌλ΅
// λ°°μΉ μ‘μ—…μΌλ΅ λ‚μ¤‘μ— λ³΄μ •
```

## π“ μ •λ¦¬

### μ μ¬ νƒ€μ΄λ°

1. **μλ„μ° μ§‘κ³„ μ¤‘**: DBμ— μ €μ¥ μ• λ¨ (μ¤νΈλ¦Όμ¦ λ‚΄λ¶€ μƒνƒλ§ μ—…λ°μ΄νΈ)
2. **μλ„μ° λ‹«ν**: Output ν† ν”½μΌλ΅ μ „μ†΅
3. **μ»¨μλ¨Έ μμ‹ **: μ¦‰μ‹ DBμ— μ €μ¥ β…

### μλ„μ°κ°€ λ‹«νλ” μ΅°κ±΄

```
ofSizeWithNoGrace:
  μλ„μ° μΆ…λ£ μ‹κ°„ μ΄ν›„ μ²« λ°μ΄ν„° λ„μ°© μ‹

ofSizeAndGrace:
  μλ„μ° μΆ…λ£ μ‹κ°„ + Grace Period μ΄ν›„ μ²« λ°μ΄ν„° λ„μ°© μ‹
```

### μ»¨μλ¨Έκ°€ μ•„λ” λ°©λ²•

```
μ»¨μλ¨Έλ” "μ• ν•„μ” μ—†μ"
β†’ Output ν† ν”½μ— λ©”μ‹μ§€κ°€ μ¤λ©΄ = μ΄λ―Έ μ§‘κ³„ μ™„λ£
β†’ κ·Έλƒ¥ λ°›μ•„μ„ μ €μ¥ν•λ©΄ λ!
```

## π€ ν…μ¤νΈ λ°©λ²•

### μ‹¤μ‹κ°„μΌλ΅ ν™•μΈν•κΈ°

```bash
# 1. μ• ν”λ¦¬μΌ€μ΄μ… μ‹¤ν–‰
./gradlew bootRun

# 2. μ²« λ²μ§Έ λ°μ΄ν„° (μλ„μ° μƒμ„±)
curl -X POST "http://localhost:8080/api/time-window/hourly-sales?product=ν…μ¤νΈ&amount=1000000"
# β†’ μ½μ†”: μ§‘κ³„ μ¤‘... (DB μ €μ¥ μ• λ¨)

# 3. λ‘ λ²μ§Έ λ°μ΄ν„° (κ°™μ€ μλ„μ°)
curl -X POST "http://localhost:8080/api/time-window/hourly-sales?product=ν…μ¤νΈ&amount=2000000"
# β†’ μ½μ†”: μ§‘κ³„ μ¤‘... (DB μ €μ¥ μ• λ¨)

# 4. ν• μ‹κ°„ λ’¤ λ°μ΄ν„° μ „μ†΅ (μλ„μ° λ‹«κΈ° νΈλ¦¬κ±°)
# β†’ μ΄μ „ μλ„μ° κ²°κ³Όκ°€ Output ν† ν”½μΌλ΅ μ „μ†΅λ¨
# β†’ μ½μ†”: β… DB μ €μ¥ μ™„λ£!
```

### λΉ λ¥Έ ν…μ¤νΈ (1λ¶„ μλ„μ°)

ν…μ¤νΈμ©μΌλ΅ 1λ¶„ μλ„μ°λ¥Ό λ§λ“¤λ©΄ λΉ λ¥΄κ² ν™•μΈ κ°€λ¥:

```java
@Bean
public KStream<String, String> testStream(StreamsBuilder streamsBuilder) {
    return streamsBuilder.stream("test-topic")
        .groupByKey()
        .windowedBy(TimeWindows.ofSizeWithNoGrace(Duration.ofMinutes(1))) // 1λ¶„
        .aggregate(...)
        .toStream()
        .to("test-output-topic");
}
```

μ΄μ  μλ„μ° νƒ€μ΄λ°κ³Ό DB μ μ¬ μ‹μ μ΄ λ…ν™•ν•κ² μ΄ν•΄λμ…¨λ‚μ”? π“

